# Maslow4 CNC Router Configuration
# Only includes settings that differ from defaults.

board: Maslow4
name: Maslow CNC Router
meta: 
stepping:
  # Preferred stepping engine: RMT (not yet implemented for ESP32-S3).
  engine: Timed
  # Disable stepper after 250ms of inactivity
  idle_ms: 250

spi:
  miso_pin: gpio.13
  mosi_pin: gpio.11
  sck_pin: gpio.12

sdcard:
  cs_pin: gpio.10

uart1:
  txd_pin: gpio.1
  rxd_pin: gpio.2
  
kinematics:
  QuadCable:
    # Anchor distances (mm)
    d_bl_tl: 300.0
    d_bl_br: 400.0
    d_br_tr: 300.0
    d_tl_tr: 400.0
    d_bl_tr: 500.0
    # Diagonal BR-TL is used for validation
    d_br_tl: 500.0

axes:
  z:
    steps_per_mm: 100
    max_rate_mm_per_min: 400
    acceleration_mm_per_sec2: 10

    motor0:
      tmc_2209:
        uart_num: 1
        addr: 0
        r_sense_ohms: 0.110
        run_amps: 1.000
        microsteps: 1
        run_mode: StealthChop
        use_enable: true
        direction_pin: gpio.16
        step_pin: gpio.15
        # Homing mode is not used, but we must set a homing_amps value to avoid a warning in the console
        homing_amps: 1.000

    motor1:
      tmc_2209:
        uart_num: 1
        addr: 1
        r_sense_ohms: 0.110
        run_amps: 1.000
        microsteps: 1
        run_mode: StealthChop
        homing_mode: StealthChop
        use_enable: true
        direction_pin: gpio.38
        step_pin: gpio.46
        homing_amps: 1.000

maslow:

  # [ms] Time between each cycle of the main loop (FreeRTOS task).
  # The main loop reads the encoders and updates belt motor speeds.
  # This is the minimum time between each cycle, but the actual time may be longer if 
  # the loop takes longer to execute, in which case an warning is issued.
  cycle_time: 10

  fan_pin: gpio.47

  # I2C switch for the belt encoders
  i2c_switch:
    scl_pin: gpio.4
    sda_pin: gpio.5
    address: 0x70
    frequency: 400000

  # Belts
  tl:
    retract_speed: 1.0
    retract_current: 0.6
    max_direction_errors: 10
    max_movement_errors: 50
    encoder:
      port: 2
      mm_per_revolution: 44.0
      invert: true
    motor:
      fwd_pin: gpio.45
      rev_pin: gpio.21
      frequency: 4000
      current_sense_pin: gpio.18
      current_sense_resistor: 1500
      overcurrent_warning: 0.9
      overcurrent_error: 1.4
      reverse: true

  tr:
    retract_speed: 1.0
    retract_current: 0.6
    max_direction_errors: 10
    max_movement_errors: 50
    encoder:
      port: 1
      mm_per_revolution: 44.0
      invert: true
    motor:
      fwd_pin: gpio.42
      rev_pin: gpio.41
      frequency: 4000
      current_sense_pin: gpio.6
      current_sense_resistor: 1500
      overcurrent_warning: 0.9
      overcurrent_error: 1.4
      reverse: true

  bl:
    retract_speed: 1.0
    retract_current: 0.6
    max_direction_errors: 10
    max_movement_errors: 50
    encoder:
      port: 3
      mm_per_revolution: 44.0
      invert: true
    motor:
      fwd_pin: gpio.37
      rev_pin: gpio.36
      frequency: 4000
      current_sense_pin: gpio.8
      current_sense_resistor: 1500
      overcurrent_warning: 0.9
      overcurrent_error: 1.4
      reverse: true

  br:
    retract_speed: 1.0
    retract_current: 0.6
    max_direction_errors: 10
    max_movement_errors: 50
    encoder:
      port: 0
      mm_per_revolution: 44.0
      invert: true
    motor:
      fwd_pin: gpio.9
      rev_pin: gpio.3
      frequency: 4000
      current_sense_pin: gpio.7
      current_sense_resistor: 1500
      overcurrent_warning: 0.9
      overcurrent_error: 1.4
      reverse: true
